@using CoachAssistant.Client.Pages
@using CoachAssistant.Client.Pages.Tournaments
@inherits LayoutComponentBase

<MudLayout>
    @if (isAuthenticated)
    {
        <MudAppBar>
            <MudGrid>
                <MudItem xs="9">
                    <MudPaper Elevation="0" Class="d-flex align-center" Style="background-color: transparent;">
                        <MudIconButton Icon="@Icons.Material.Filled.Menu" Style="color: white" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
                        <MudText Typo="Typo.h6" Class="mr-2" Style="color: white">Team assistant</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="3">
                    @if (isAuthenticated)
                    {
                        <MudPaper Elevation="0" Class="d-flex align-center justify-end mt-1" Style="background-color: transparent;">
                            <MudText Typo="Typo.h6" Class="mr-2" Style="color: white">Вітаємо, @userName!</MudText>
                                <MudButton Variant="Variant.Text" OnClick="@Logout" Color="Color.Secondary">Вийти</MudButton>
                            </MudPaper>
                    }
                </MudItem>
            </MudGrid>
        </MudAppBar>
        <MudDrawer @bind-Open="@_drawerOpen">
            <NavMenu />
        </MudDrawer>
    }
    <MudMainContent Style="@(isAuthenticated ? "" : "padding: 0px;")">
        @Body
    </MudMainContent>
</MudLayout>

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IAccountManager AccountManager;
@inject ILocalStorageService LocalStorage
@inject IHttpClientService HttpClientService
@inject IDialogService DialogService

@code {
    private bool isAuthenticated = false;
    private bool isManager = false;
    private string userName = "";

    bool _drawerOpen = true;

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        isAuthenticated = authState.User.Identity.IsAuthenticated;
        userName = authState.User.Identity.IsAuthenticated ? authState.User.Identity.Name : "Guest";

        isManager = await AccountManager.IsUserInRole("Manager");
    }

    private async Task Logout()
    {
        await LocalStorage.RemoveItemAsync("AccessToken");
        await HttpClientService.PostAsync(ApiUrls.RevokeUrl, "revoke");

        AccountManager.MarkUserAsLoggedOut();
        NavigationManager.NavigateTo("/login", forceLoad: true);
    }
}
