@page "/login"

<h3>Login</h3>
<EditForm Model="@user">
    <InputText @bind-Value="user.Username" />
    <InputText @bind-Value="user.Password" type="password" />
    <button type="submit" @onclick="LoginUser">Login</button>
</EditForm>

@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject IHttpClientService HttpClientService
@inject SignalRService SignalRService

@code {
    LoginModel user = new();

    async Task LoginUser()
    {
        var identityModel = await HttpClientService.PostAsync<LoginModel, IdentityModel>(ApiUrls.LoginUrl, user);

        await LocalStorage.SetItemAsync($"{nameof(identityModel.Tokens.AccessToken)}", identityModel.Tokens.AccessToken);
        await LocalStorage.SetItemAsync($"{nameof(identityModel.Tokens.RefreshToken)}", identityModel.Tokens.RefreshToken);
        await LocalStorage.SetItemAsync($"{nameof(identityModel.DomainUserId)}", identityModel.DomainUserId);

        await AuthStateProvider.GetAuthenticationStateAsync();

        await SignalRService.StartConnectionAsync();
        NavigationManager.NavigateTo("/add-team-club");
    }
}
